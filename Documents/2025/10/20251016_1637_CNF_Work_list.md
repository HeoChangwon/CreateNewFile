# CreateNewFile 윈도우 위치 복원 작업 목록

> 작성일: 2025-10-16 16:37
> 프로젝트: CreateNewFile WPF Application
> 작업자: Claude Code Assistant

## 작업 개요

이번 세션에서는 CreateNewFile WPF 애플리케이션의 템플릿 파일명 표시 개선과 윈도우 위치 복원 기능 구현을 시도했습니다.

## 완료된 작업

### 1. 템플릿 파일명 표시 개선 ✅

**작업 내용:**
- 템플릿 파일 전체 경로 아래에 파일명만 별도로 표시
- 파일명 스타일을 기울임체에서 보통체로 변경

**수정 파일:**
- `MainWindow.xaml`: TextBlock 추가 (라인 407-413)
- `MainViewModel.cs`: `TemplateFileName` 속성 추가 (라인 31, 158-173)

**결과:**
- 템플릿 경로 콤보박스 아래에 파일명만 보통체로 표시됨
- 사용자가 파일명을 더 쉽게 확인 가능

### 2. Stylus/터치 지원 비활성화 ✅

**문제:**
- `mainWindow.Show()` 실행 시 `System.InvalidOperationException` 발생
- 에러 메시지: "Operation is not valid due to the current state of the object"
- 원인: WPF Stylus 시스템 초기화와 윈도우 속성 설정 충돌

**해결 방법:**
- `App.xaml.cs`에 생성자 추가
- `AppContext.SetSwitch`로 스타일러스/터치 지원 비활성화

```csharp
public App()
{
    AppContext.SetSwitch("Switch.System.Windows.Input.Stylus.DisableStylusAndTouchSupport", true);
}
```

**결과:**
- Stylus 예외 해결됨
- 프로그램이 정상적으로 시작됨

## 미해결 문제 ⚠️

### 윈도우 위치 복원 실패

**증상:**
- 프로그램 실행 시 이전 세션의 윈도우 위치가 복원되지 않음
- 설정 파일(`appsettings.json`)은 정상적으로 저장/로드됨
- 디버그 출력에서 "저장된 위치 적용: 100, 100" 메시지 확인됨
- 그러나 실제 윈도우는 다른 위치에 표시됨

**시도한 해결 방법:**

1. **SourceInitialized 이벤트에서 복원** → Stylus 예외 발생
2. **Dispatcher.BeginInvoke로 지연 실행** → 위치 유지 안 됨
3. **Loaded 이벤트에서 복원** → 위치 유지 안 됨
4. **Hidden/Visible 패턴 사용** → 윈도우 사라짐
5. **생성자에서 복원** → Stylus 예외 발생
6. **PrepareWindow() 메서드로 Show() 전 복원** → 위치 유지 안 됨

**현재 코드 구조:**

```csharp
// App.xaml.cs
Dispatcher.BeginInvoke(new Action(async () =>
{
    mainWindow.PrepareWindow();  // 위치 복원
    mainWindow.Show();           // 윈도우 표시
    // ... 초기화
}), DispatcherPriority.ApplicationIdle);

// MainWindow.xaml.cs
public void PrepareWindow()
{
    RestoreWindowPositionSync();  // 설정 파일에서 위치 읽어서 복원
}
```

**디버그 출력 분석:**
```
=== PrepareWindow 호출됨 ===
설정 파일 경로: C:\Users\user\AppData\Local\CreateNewFile\config\appsettings.json
파일 존재 여부: True
저장된 위치 적용: 100, 100
윈도우 상태 복원: Normal
복원 후 위치: Left=100, Top=100, Width=620, Height=1000
=== PrepareWindow 완료 ===
```

- 설정 파일은 정상적으로 읽힘
- 윈도우 속성(Left, Top)은 올바르게 설정됨
- 하지만 실제 표시 위치는 다름

**가능한 원인:**
1. WPF가 `Show()` 호출 시 윈도우 위치를 재계산하는 것으로 추정
2. `WindowStartupLocation="Manual"` 설정이 제대로 작동하지 않을 수 있음
3. Dispatcher 우선순위(`ApplicationIdle`) 때문에 다른 시스템이 개입할 가능성
4. DPI 스케일링이나 다중 모니터 환경 문제일 수 있음

## 다음 Chat에서 해결할 사항

### 필수 작업

1. **윈도우 위치 복원 문제 해결**
   - WPF 윈도우 생명주기 재검토
   - `WindowStartupLocation` 속성 확인
   - DPI 스케일링 고려
   - 다중 모니터 환경 테스트

2. **대안 접근 방법**
   - `Window.Left/Top` 대신 Win32 API 사용 고려
   - `SourceInitialized` 이벤트에서 Win32 SetWindowPos 사용
   - PInvoke를 통한 직접 윈도우 위치 제어

## 수정된 파일 목록

```
D:\Work_Claude\2025\08\CreateNewFile\CreateNewFile\CreateNewFile\
├── App.xaml.cs (생성자 추가, Stylus 비활성화)
├── Views\
│   ├── MainWindow.xaml (템플릿 파일명 TextBlock 추가)
│   └── MainWindow.xaml.cs (PrepareWindow 메서드 추가, 디버그 출력 추가)
└── ViewModels\
    └── MainViewModel.cs (TemplateFileName 속성 추가)
```

## 기술적 세부사항

### 설정 파일 구조 (appsettings.json)

```json
{
  "UI": {
    "WindowWidth": 900.0,
    "WindowHeight": 600.0,
    "WindowLeft": 100.0,
    "WindowTop": 100.0,
    "WindowState": "Normal",
    "Theme": "Light",
    "Language": "ko-KR",
    "AutoSave": true,
    "RestoreLastSettings": true
  }
}
```

### 윈도우 위치 저장 로직

**저장 시점:** `MainWindow_Closing` 이벤트
- 최소화 상태는 저장하지 않음
- 최대화 상태일 때는 `RestoreBounds` 저장
- 일반 상태일 때는 현재 위치/크기 저장

**복원 시점:** `PrepareWindow()` 메서드 (Show() 전)
- 설정 파일에서 JSON 읽기
- 화면 경계 검증
- 윈도우 속성 설정 (Left, Top, Width, Height, WindowState)

## 참고 자료

### WPF 윈도우 생명주기

1. **생성자** → InitializeComponent()
2. **SourceInitialized** → 윈도우 핸들 생성됨
3. **Loaded** → 모든 요소 로드 완료
4. **ContentRendered** → 첫 렌더링 완료
5. **Activated** → 윈도우 활성화
6. **Closing** → 닫기 시작
7. **Closed** → 완전히 닫힘

### Stylus 예외 관련

- **문제:** WPF 8.0에서 Stylus/터치 시스템 초기화 타이밍 이슈
- **해결:** 애플리케이션 시작 시 해당 시스템 비활성화
- **영향:** 터치/펜 입력 사용 불가 (마우스/키보드는 정상)
- **대부분의 데스크톱 애플리케이션에는 영향 없음**

## 빌드 정보

- **빌드 날짜:** 2025-10-16
- **빌드 결과:** 성공 (경고 38개, 오류 0개)
- **타겟 프레임워크:** .NET 8.0 Windows
- **프로젝트:** CreateNewFile.csproj

## 다음 세션 시작 시 확인사항

1. ✅ 프로그램 정상 실행 여부
2. ✅ Stylus 예외 발생 여부
3. ⚠️ 윈도우 위치 복원 여부
4. ✅ 템플릿 파일명 표시 여부
5. ⚠️ 윈도우 이동 후 재시작 시 위치 유지 여부

---

## 결론

이번 세션에서 템플릿 파일명 표시 개선과 Stylus 예외는 성공적으로 해결했으나, 윈도우 위치 복원 기능은 여전히 작동하지 않습니다. 설정 파일의 읽기/쓰기는 정상적으로 작동하며, 윈도우 속성도 올바르게 설정되지만, WPF가 실제로 윈도우를 표시할 때 다른 위치에 배치하는 것으로 보입니다.

다음 세션에서는 Win32 API를 활용한 직접적인 윈도우 위치 제어나 다른 접근 방법을 시도해야 할 것으로 판단됩니다.
