# CreateNewFile - 작업 내역

**작성일:** 2025-10-16 17:12  
**작성자:** 허창원 ((주)그린파워)  
**AI 지원:** Claude Code Assistant  
**프로젝트:** CreateNewFile WPF Application

---

## 작업 개요

이번 Chat에서는 CreateNewFile 프로그램의 **윈도우 위치 복원 문제**를 해결하고, 관련 버그를 수정했습니다.

---

## 주요 작업 내역

### 1. 윈도우 위치 복원 문제 진단 및 해결

#### 1.1 문제 상황
- 프로그램을 종료한 후 다시 실행하면 이전 위치가 아닌 항상 (100, 100) 위치에 표시됨
- 설정 파일(`appsettings.json`)에는 위치가 저장되지만, 실제로 적용되지 않음
- 디버그 로그에서 "저장된 위치 적용: 100, 100"으로 출력됨

#### 1.2 원인 분석
1. **WPF 윈도우 초기화 순서 문제**
   - `PrepareWindow()`에서 위치를 설정해도 `Show()` 시점에 WPF 내부 메커니즘에 의해 재설정됨

2. **저장 순서 문제**
   - `MainViewModel.SaveCurrentStateAsync()`가 먼저 실행되면서 설정 파일을 저장
   - 이후 `SaveWindowPositionSync()`가 실행되어도 일부 값이 덮어써지는 문제 발생 가능

#### 1.3 적용한 해결 방법

**A. SourceInitialized 이벤트 활용**
- 파일: `MainWindow.xaml.cs`
- 위치: 라인 36, 55-67
- 내용:
  ```csharp
  // 생성자에서 이벤트 등록
  this.SourceInitialized += MainWindow_SourceInitialized;

  // 이벤트 핸들러
  private void MainWindow_SourceInitialized(object? sender, EventArgs e)
  {
      if (_isWindowPositionRestored)
          return;

      RestoreWindowPositionSync();
      _isWindowPositionRestored = true;
  }
  ```
- 효과: 윈도우의 네이티브 핸들이 생성된 직후(화면 표시 직전)에 위치를 복원하여 안정적으로 적용

**B. 저장 순서 변경**
- 파일: `MainWindow.xaml.cs`
- 위치: 라인 92-116 (MainWindow_Closing 메서드)
- 변경 내용:
  ```csharp
  // 이전: MainViewModel.SaveCurrentStateAsync() → SaveWindowPositionSync()
  // 현재: SaveWindowPositionSync() → MainViewModel.SaveCurrentStateAsync()
  ```
- 효과: 윈도우 위치가 먼저 저장되어 다른 설정에 의해 덮어써지지 않음

**C. 상세 디버그 로그 추가**
- 파일: `MainWindow.xaml.cs`
- 위치: 라인 220-309 (SaveWindowPositionSync 메서드)
- 추가된 로그:
  - 저장 시작/완료 시점
  - 현재 윈도우 속성값 (Left, Top, Width, Height)
  - 설정 파일 로드/저장 상태
  - 저장되는 실제 값
  - JSON 파일 크기

### 2. ValidateWritePermission 메서드 버그 수정

#### 2.1 문제 상황
- 파일: `ValidationHelper.cs`
- 메서드: `ValidateWritePermission()`
- 오류: `System.IO.DirectoryNotFoundException`
- 원인: 폴더가 존재하지 않는 경우 `File.WriteAllText()` 호출 시 예외 발생

#### 2.2 해결 방법
- 파일: `ValidationHelper.cs`
- 위치: 라인 421-451
- 수정 내용:
  ```csharp
  public static ValidationResult ValidateWritePermission(string folderPath)
  {
      try
      {
          // 먼저 폴더가 존재하는지 확인
          if (!Directory.Exists(folderPath))
          {
              return ValidationResult.CreateFailure(
                  "폴더가 존재하지 않습니다. 폴더를 생성하거나 유효한 경로를 지정해주세요.");
          }

          // ... 권한 확인 로직
      }
      catch (DirectoryNotFoundException)
      {
          return ValidationResult.CreateFailure(
              "폴더를 찾을 수 없습니다. 경로를 확인해주세요.");
      }
      // ... 기타 예외 처리
  }
  ```
- 효과: 폴더가 없는 경우 명확한 오류 메시지 제공

---

## 수정된 파일 목록

### 1. MainWindow.xaml.cs
- 경로: `D:\Work_Claude\2025\08\CreateNewFile\CreateNewFile\CreateNewFile\Views\MainWindow.xaml.cs`
- 주요 변경사항:
  - SourceInitialized 이벤트 핸들러 추가
  - MainWindow_Closing 메서드에서 저장 순서 변경
  - SaveWindowPositionSync 메서드에 상세 디버그 로그 추가
  - PrepareWindow 메서드 간소화

### 2. ValidationHelper.cs
- 경로: `D:\Work_Claude\2025\08\CreateNewFile\CreateNewFile\CreateNewFile\Utils\ValidationHelper.cs`
- 주요 변경사항:
  - ValidateWritePermission 메서드에 폴더 존재 여부 확인 로직 추가
  - DirectoryNotFoundException 예외 처리 추가

---

## 테스트 방법

### 윈도우 위치 복원 테스트

1. **Visual Studio에서 디버그 실행 (F5)**
2. **테스트 절차:**
   - 프로그램 실행 후 윈도우를 다른 위치로 이동 (예: 오른쪽 하단)
   - 프로그램 종료 (X 버튼)
   - Output 창(Ctrl+Alt+O)에서 디버그 로그 확인:
     ```
     === MainWindow_Closing 시작 ===
     종료 직전 윈도우 위치: Left=[실제값], Top=[실제값], ...
     === SaveWindowPositionSync 시작 ===
     현재 윈도우 속성: Left=[실제값], Top=[실제값], ...
     일반 상태 - 현재 위치/크기 저장: Left=[실제값], Top=[실제값], ...
     JSON 파일 저장 완료 (크기: ... bytes)
     === SaveWindowPositionSync 완료 ===
     ```
   - 저장된 Left, Top 값이 이동한 위치와 일치하는지 확인
   - 프로그램 재실행
   - 윈도우가 이전 위치에 표시되는지 확인

3. **설정 파일 확인:**
   ```powershell
   notepad "$env:LOCALAPPDATA\CreateNewFile\config\appsettings.json"
   ```
   - `UI` 섹션의 `WindowLeft`, `WindowTop` 값 확인

---

## 기술적 세부사항

### WPF 윈도우 생명주기 이벤트

1. **생성자 (Constructor)**
   - InitializeComponent() 호출
   - 이벤트 핸들러 등록

2. **SourceInitialized** ⭐ (이번 수정에서 활용)
   - 윈도우의 네이티브 핸들(HWND) 생성 직후
   - Win32 API 호출 가능
   - 위치/크기 설정에 최적

3. **Loaded**
   - XAML 요소가 모두 로드됨
   - 시각적 트리 구성 완료

4. **ContentRendered**
   - 콘텐츠가 화면에 렌더링된 후

5. **Closing**
   - 윈도우가 닫히기 직전
   - 설정 저장에 활용

### 설정 파일 구조

```json
{
  "UI": {
    "WindowWidth": 900.0,
    "WindowHeight": 600.0,
    "WindowLeft": [실제 위치],
    "WindowTop": [실제 위치],
    "WindowState": "Normal",
    ...
  },
  ...
}
```

---

## 다음 작업 예정

1. **다중 모니터 환경 테스트**
   - 여러 모니터에서 위치 복원 정상 작동 확인
   - DPI 스케일링 처리 검증

2. **추가 개선 사항**
   - 윈도우가 화면 밖으로 벗어난 경우 처리
   - 모니터 구성 변경 시 대응

3. **성능 최적화**
   - 설정 저장 시 불필요한 파일 읽기/쓰기 최소화

---

## 참고 문서

- **Quick Reference:** `Documents/Project_overview/20251016_1638_CNF_Quick_Reference_v01.md`
- **프로젝트 개요:** `Documents/Project_overview/20250930_1557_CreateNewFile_Project_overview.md`
- **CLAUDE.md:** 빌드 명령 및 프로젝트 아키텍처

---

## 빌드 명령

```bash
cd "D:\Work_Claude\2025\08\CreateNewFile\CreateNewFile\CreateNewFile"
dotnet build
dotnet run
```

---

## 작업 완료 상태

- ✅ 윈도우 위치 복원 문제 해결
- ✅ ValidateWritePermission 버그 수정
- ✅ 디버그 로그 추가
- ✅ 빌드 및 컴파일 성공
- ⏳ 실제 테스트 대기 중

---

**작업 완료 시간:** 2025-10-16 17:12  
**다음 Chat 예정:** 윈도우 위치 복원 테스트 결과 확인 및 추가 개선
