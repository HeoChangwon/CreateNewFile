# CreateNewFile 작업 내역
**작업 일시**: 2025-10-16
**문서 생성**: 2025-10-16 19:17

---

## 📋 작업 개요

이번 작업에서는 CreateNewFile 프로그램의 창 위치 저장 문제를 해결하고, NSIS 인스톨러 관련 개선 작업을 수행했습니다.

---

## 🔧 주요 작업 내역

### 1. 창 위치 저장 문제 해결 ⭐ (핵심 작업)

**문제 상황:**
- 프로그램 종료 시 창 위치가 올바르게 저장되지 않는 문제 발생
- 실제 창 위치(예: 2896, 664)가 아닌 초기값(100, 100)이 저장됨
- 다음 실행 시 항상 초기 위치에서 창이 열림

**원인 분석:**
- `MainWindow.xaml.cs`에서 독립적인 `SettingsService` 인스턴스 생성
- `MainViewModel`은 DI 컨테이너에서 주입받은 다른 `SettingsService` 인스턴스 사용
- 두 인스턴스가 서로 다른 캐시를 유지하여 데이터 불일치 발생
- 실행 흐름:
  1. `SaveWindowPositionSync()`: MainWindow의 SettingsService로 실제 위치 저장
  2. `SaveCurrentStateAsync()`: MainViewModel의 SettingsService가 오래된 캐시(초기값) 사용
  3. 결과: 초기값으로 다시 덮어써짐

**해결 방법:**

**1) SettingsService에 캐시 무효화 기능 추가**
- 파일: `src/CreateNewFile/Services/SettingsService.cs`
- 위치: Line 609-616
- 내용: `ClearCache()` 메서드 추가
```csharp
public void ClearCache()
{
    lock (_lockObject)
    {
        _cachedSettings = null;
    }
}
```

**2) ISettingsService 인터페이스 확장**
- 파일: `src/CreateNewFile/Services/ISettingsService.cs`
- 위치: Line 120-124
- 내용: `ClearCache()` 메서드 선언 추가

**3) MainViewModel에 래퍼 메서드 추가**
- 파일: `src/CreateNewFile/ViewModels/MainViewModel.cs`
- 위치: Line 1441-1444
- 내용: `ClearSettingsCache()` 메서드 추가
```csharp
public void ClearSettingsCache()
{
    _settingsService.ClearCache();
}
```

**4) MainWindow_Closing 이벤트 수정**
- 파일: `src/CreateNewFile/Views/MainWindow.xaml.cs`
- 위치: Line 92-114
- 내용: 창 위치 저장 후 캐시 무효화 호출
```csharp
// 윈도우 위치를 먼저 저장
SaveWindowPositionSync();

// SettingsService 캐시 무효화
viewModel.ClearSettingsCache();

// MainViewModel의 현재 상태 저장
Task.Run(async () => await viewModel.SaveCurrentStateAsync()).Wait(TimeSpan.FromSeconds(5));
```

**결과:**
- 프로그램 종료 시 실제 창 위치가 정확하게 저장됨
- 다음 실행 시 마지막 위치에서 창이 올바르게 복원됨
- 사용자 확인: "이제야 윈도 창의 위치가 다음 실행시에 제대로 유지됩니다"

---

### 2. 디버그 로그 코드 제거

**작업 내용:**
프로덕션 코드에 남아있던 모든 디버그 로그를 제거하여 코드를 정리했습니다.

**수정된 파일:**

**1) MainWindow.xaml.cs**
- `PrepareWindow()` 메서드 간소화
- `MainWindow_SourceInitialized()` 간소화
- `RestoreWindowPositionSync()`: Debug.WriteLine 제거
- `SaveWindowPositionSync()`: Debug.WriteLine 제거
- `RegisterDragDropForElement()`: Debug.WriteLine 제거

**2) MainViewModel.cs**
- `SaveLastSelectedItemsAsync()` 메서드에서 Debug.WriteLine 제거
- 예외 처리 간소화

**3) SettingsService.cs**
- `ClearCache()` 메서드에서 Debug.WriteLine 제거

**결과:**
- 깔끔한 프로덕션 코드 유지
- 불필요한 로그 출력 제거

---

### 3. NSIS 인스톨러 BrandingText 추가

**작업 내용:**
NSIS 설치 프로그램 하단에 제품 정보를 표시하는 BrandingText를 추가했습니다.

**수정된 파일:**
- 파일: `NSIS_installer/CreateNewFile_Installer.nsi`
- 위치: Line 36
- 내용:
```nsis
; Branding text (bottom of installer window)
BrandingText "${PRODUCT_NAME} v${PRODUCT_VERSION} (Build: ${DISPLAY_BUILD_DATE})"
```

**결과:**
- 설치 프로그램 하단에 "CreateNewFile v1.0.3.0 (Build: 2025-10-16 17:50)" 형식으로 표시됨

---

### 4. NSIS 빌드 인코딩 오류 해결 ⭐ (중요)

**문제 상황:**
```
오류: NSIS 빌드 실패!
오류 메시지: Bad text encoding: temp_installer.nsi:10
Error in script "temp_installer.nsi" on line 10 -- aborting creation process
```

**원인 분석:**
- Python 스크립트가 `encoding='utf-8'`로 임시 NSI 파일 저장
- UTF-8 without BOM은 NSIS가 ANSI로 인식
- Line 10의 한글 주석 `; 빌드 날짜 (표시용, YYYY-MM-DD HH:MM 형식)`이 ANSI로 해석되면서 오류 발생
- NSIS는 UTF-8 파일을 인식하기 위해 BOM(Byte Order Mark)이 필요

**해결 방법:**

**1) Python 스크립트 인코딩 변경**

**파일 1**: `NSIS_installer/12_BuildInstaller.py`
- 위치: Line 110-113
- 변경 전: `encoding='utf-8'`
- 변경 후: `encoding='utf-8-sig'`
```python
# 임시 NSI 파일 생성 (UTF-8 BOM으로 저장하여 NSIS가 UTF-8로 인식하도록 함)
temp_nsi = Path("temp_installer.nsi")
with open(temp_nsi, 'w', encoding='utf-8-sig') as f:
    f.write('\n'.join(lines))
```

**파일 2**: `NSIS_installer/10_BuildAll.py`
- 위치: Line 203-206
- 변경 내용: 동일하게 `encoding='utf-8-sig'`로 변경

**2) NSI 스크립트 주석 영문화 (추가 안전장치)**
- 파일: `NSIS_installer/CreateNewFile_Installer.nsi`
- 위치: Line 10
- 변경 전: `; 빌드 날짜 (표시용, YYYY-MM-DD HH:MM 형식)`
- 변경 후: `; Build date (YYYY-MM-DD HH:MM format)`

**3) 기존 임시 파일 삭제**
- `temp_installer.nsi` 파일 삭제하여 새로 생성되도록 함

**기술 설명:**
- `utf-8-sig`: UTF-8 인코딩에 BOM(Byte Order Mark)을 추가
- BOM은 파일 시작 부분에 `EF BB BF` 바이트를 추가하여 UTF-8 파일임을 명시
- NSIS 컴파일러가 BOM을 감지하여 UTF-8로 올바르게 인식

**결과:**
- NSIS 인스톨러 정상 빌드
- 사용자 확인: "잘 됩니다"

---

## 📁 수정된 파일 목록

### C# 소스 파일
1. `src/CreateNewFile/Services/SettingsService.cs`
   - ClearCache() 메서드 추가
   - Debug.WriteLine 제거

2. `src/CreateNewFile/Services/ISettingsService.cs`
   - ClearCache() 메서드 선언 추가

3. `src/CreateNewFile/ViewModels/MainViewModel.cs`
   - ClearSettingsCache() 래퍼 메서드 추가
   - SaveLastSelectedItemsAsync() 디버그 로그 제거

4. `src/CreateNewFile/Views/MainWindow.xaml.cs`
   - MainWindow_Closing에서 캐시 무효화 호출
   - 모든 메서드에서 Debug.WriteLine 제거

### NSIS 관련 파일
5. `NSIS_installer/CreateNewFile_Installer.nsi`
   - BrandingText 추가 (Line 36)
   - 한글 주석을 영문으로 변경 (Line 10)

6. `NSIS_installer/12_BuildInstaller.py`
   - UTF-8-sig 인코딩으로 변경 (Line 112)

7. `NSIS_installer/10_BuildAll.py`
   - UTF-8-sig 인코딩으로 변경 (Line 205)

---

## 🔑 핵심 기술 개념

### 1. Cache Invalidation Pattern (캐시 무효화 패턴)
- **문제**: 외부에서 파일을 직접 수정할 때 캐시된 데이터가 최신 상태를 반영하지 못함
- **해결**: 파일 수정 후 명시적으로 캐시를 무효화하여 다음 읽기 시 최신 데이터 로드
- **구현**: `ClearCache()` 메서드를 통해 `_cachedSettings = null` 설정

### 2. Dependency Injection (의존성 주입)
- **문제**: 서로 다른 객체가 각자의 서비스 인스턴스를 생성하여 상태 불일치 발생
- **해결**: DI 컨테이너를 통해 싱글톤 인스턴스 공유
- **주의점**: 일부 객체가 DI를 우회하여 인스턴스를 생성하는 경우 주의 필요

### 3. UTF-8 BOM (Byte Order Mark)
- **개념**: 파일의 인코딩을 명시적으로 표시하는 마커
- **UTF-8 BOM**: `EF BB BF` 3바이트로 시작
- **Python**: `encoding='utf-8-sig'`로 BOM 포함 파일 생성
- **NSIS**: BOM이 없는 UTF-8 파일을 ANSI로 오인식하여 인코딩 오류 발생

### 4. MVVM Architecture
- **Model**: 데이터 및 비즈니스 로직 (SettingsService)
- **View**: UI 표현 (MainWindow.xaml)
- **ViewModel**: View와 Model 중개 (MainViewModel)
- **주의점**: View와 ViewModel이 같은 서비스 인스턴스를 사용해야 데이터 일관성 유지

---

## ✅ 빌드 및 테스트

### 빌드 결과
- C# 프로젝트 빌드 성공
- NSIS 인스톨러 빌드 성공
- 생성된 파일: `CreateNewFile_v1.0.003_Build_20251016_1750_Setup.exe`

### 테스트 결과
1. **창 위치 저장/복원**: ✅ 정상 동작 확인
2. **NSIS 인스톨러 빌드**: ✅ 인코딩 오류 해결
3. **BrandingText 표시**: ✅ 설치 프로그램 하단에 정보 표시

---

## 📝 사용자 피드백

1. **창 위치 문제 해결 후**:
   > "이제야 윈도 창의 위치가 다음 실행시에 제대로 유지됩니다"

2. **NSIS 인코딩 문제 해결 후**:
   > "잘 됩니다"

---

## 🎯 작업 완료 항목

- [x] 창 위치 저장 문제 분석 및 해결
- [x] Cache Invalidation 패턴 구현
- [x] 디버그 로그 코드 제거
- [x] NSIS BrandingText 추가
- [x] NSIS UTF-8 인코딩 오류 해결
- [x] 전체 빌드 및 테스트 완료

---

## 📚 참고 사항

### 개발 환경
- IDE: Visual Studio
- .NET Version: 8.0
- UI Framework: WPF (Windows Presentation Foundation)
- NSIS Version: 3.x
- Python Version: 3.x

### 주요 디렉토리
- 소스 코드: `src/CreateNewFile/`
- NSIS 스크립트: `NSIS_installer/`
- 빌드 출력: `NSIS_installer/publish/framework-dependent/`

### 배포 정보
- 제품명: CreateNewFile
- 버전: 1.0.003
- 빌드 일시: 2025-10-16 17:50
- 설치 경로: C:\Program Files\CreateNewFile
- 시스템 요구사항: Windows 10 이상, .NET 8.0 Runtime

---

**문서 작성자**: Claude Code
**최종 수정**: 2025-10-16 19:17
